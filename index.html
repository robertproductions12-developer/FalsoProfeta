<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Falso Profeta Online</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- FIREBASE SDKS -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --gold: #e2b04a;
            --gold-dark: #b8860b;
            --bg: #050505;
            --card: rgba(15, 15, 15, 0.9);
            --accent: #ff3e3e;
            --transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg);
            color: white;
            height: 100vh;
            overflow: hidden;
            background: radial-gradient(circle at center, #1a150a 0%, #050505 100%);
        }

        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%; width: 100%;
            padding: 25px;
            text-align: center;
            position: absolute;
            top: 0; left: 0;
            z-index: 10;
        }

        .active { display: flex; animation: fadeInScale 0.6s var(--transition); }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        #video-intro {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover; z-index: -1;
            opacity: 0.4;
        }

        .btn {
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
            border: 1px solid rgba(226, 176, 74, 0.3);
            color: white;
            padding: 16px 25px;
            border-radius: 14px;
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            width: 100%;
            max-width: 280px;
            margin: 8px 0;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        .btn-gold { background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); color: #000; border: none; }
        .btn-accent { background: var(--accent); border: none; }

        .glass-card {
            background: var(--card);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 28px;
            padding: 30px 20px;
            width: 100%; max-width: 340px;
        }

        input[type="text"] {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 14px; border-radius: 12px;
            color: white; width: 100%; margin-bottom: 12px;
            text-align: center; font-size: 16px;
        }

        .player-badge {
            background: rgba(255,255,255,0.05);
            padding: 10px; border-radius: 10px; margin: 5px 0;
            display: flex; align-items: center; gap: 10px; justify-content: center;
        }

        #timer { font-size: 60px; font-weight: 900; color: var(--gold); }
        
        .clue-box {
            background: var(--gold);
            color: black;
            padding: 8px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 12px;
            margin-top: 5px;
        }

        footer { position: fixed; bottom: 15px; width: 100%; text-align: center; font-size: 9px; opacity: 0.4; }
    </style>
</head>
<body>

    <video id="video-intro" autoplay muted loop playsinline>
        <source src="logo_animado.mp4" type="video/mp4">
    </video>

    <!-- 1. LOGIN -->
    <div id="screen-login" class="screen active">
        <div class="glass-card">
            <h2 style="color:var(--gold); margin-bottom: 20px;">BIENVENIDO</h2>
            <input type="text" id="login-name" placeholder="Tu nombre o Nick">
            <button class="btn btn-gold" onclick="loginAnonymously()">ENTRAR AL JUEGO</button>
        </div>
    </div>

    <!-- 2. MENU PRINCIPAL -->
    <div id="screen-menu" class="screen">
        <h1 style="color: var(--gold); font-size: 2.2rem; margin-bottom: 20px;">EL FALSO PROFETA</h1>
        <div class="glass-card">
            <button class="btn btn-gold" onclick="createRoom()">CREAR SALA ONLINE</button>
            <button class="btn" onclick="showScreen('screen-join-room')">UNIRSE A SALA</button>
            <button class="btn btn-accent" onclick="logout()">CERRAR SESIÓN</button>
        </div>
    </div>

    <!-- 3. CREAR SALA (LOBBY HOST) -->
    <div id="screen-create-room" class="screen">
        <div class="glass-card">
            <h2 style="color:var(--gold)">CÓDIGO DE SALA</h2>
            <div id="room-code-display" style="font-size: 35px; font-weight: 900; color: white; letter-spacing: 5px; margin: 15px 0;">------</div>
            <p style="font-size: 11px; margin-bottom: 15px; opacity: 0.7;">Jugadores conectados:</p>
            <div id="lobby-players-host" style="margin-bottom: 20px;"></div>
            <button class="btn btn-gold" onclick="hostStartGame()">INICIAR PARTIDA</button>
            <button class="btn" onclick="showScreen('screen-menu')">SALIR</button>
        </div>
    </div>

    <!-- 4. UNIRSE A SALA -->
    <div id="screen-join-room" class="screen">
        <div class="glass-card">
            <h2 style="color:var(--gold)">UNIRSE</h2>
            <input type="text" id="join-code-input" placeholder="CÓDIGO" style="text-transform: uppercase;">
            <button class="btn btn-gold" onclick="joinRoom()">ENTRAR</button>
            <button class="btn" onclick="showScreen('screen-menu')">VOLVER</button>
        </div>
    </div>

    <!-- 5. ESPERA EN LOBBY (GUEST) -->
    <div id="screen-lobby-guest" class="screen">
        <div class="glass-card">
            <h2 style="color:var(--gold)">EN LA SALA</h2>
            <p style="font-size: 12px; margin: 10px 0;">Esperando al Host...</p>
            <div id="lobby-players-guest" style="margin: 20px 0;"></div>
        </div>
    </div>

    <!-- 6. ROL Y PISTA -->
    <div id="screen-reveal" class="screen">
        <div class="glass-card">
            <h2 id="role-title">TU ROL</h2>
            <div id="secret-word" style="font-size: 24px; color: var(--gold); margin: 20px 0; font-weight: 900;">---</div>
            <p id="secret-quote" style="font-style: italic; font-size: 12px; margin-bottom: 20px; opacity: 0.8;"></p>
            <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                <p style="font-size: 11px; margin-bottom: 10px;">TU PISTA (MÁX 2 PALABRAS):</p>
                <input type="text" id="clue-input" placeholder="Ej: Gran Diluvio">
                <button class="btn btn-gold" onclick="sendClue()">ENVIAR PISTA</button>
            </div>
        </div>
    </div>

    <!-- 7. TABLERO DE JUEGO -->
    <div id="screen-board" class="screen">
        <div id="timer">05:00</div>
        <div id="players-clues-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 400px; margin: 20px 0;"></div>
        <p style="font-size: 12px; opacity: 0.6;">Debatan... ¿Quién miente?</p>
    </div>

    <!-- 8. VOTACIÓN -->
    <div id="screen-vote" class="screen">
        <h2 style="color: var(--accent); margin-bottom: 20px;">¿QUIÉN ES EL IMPOSTOR?</h2>
        <div id="vote-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 400px;"></div>
    </div>

    <!-- 9. RESULTADO -->
    <div id="screen-result" class="screen">
        <div class="glass-card">
            <h2 id="result-status">-</h2>
            <p style="font-size: 11px; opacity: 0.6; margin-top: 10px;">EL FALSO PROFETA ERA:</p>
            <h1 id="reveal-impostor-name" style="color: var(--gold);">---</h1>
            <button class="btn btn-gold" onclick="location.reload()">VOLVER AL INICIO</button>
        </div>
    </div>

    <footer>DISEÑADO POR - ROBERT PARACO</footer>

    <script>
        const firebaseConfig = {
             apiKey: "AIzaSyCc0dMjTppOlnGV_NuXCFUGhx7882qbZlE",
             authDomain: "falsoprofeta-6e682.firebaseapp.com",
             projectId: "falsoprofeta-6e682",
             storageBucket: "falsoprofeta-6e682.firebasestorage.app",
             messagingSenderId: "480777785862",
             appId: "1:480777785862:web:8c5886c6e9a2d132356987"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let currentRoomId = null;
        let isHost = false;
        let roomUnsub = null;
        let playersUnsub = null;

        const phrases = [
            {w: "Adán", q: "Formado del polvo de la tierra (Génesis 2:7)"},
            {w: "Eva", q: "Madre de todos los vivientes (Génesis 3:20)"},
            {w: "Noé", q: "Varón justo… caminó con Dios (Génesis 6:9)"},
            {w: "Moisés", q: "Yo estaré contigo (Éxodo 3:12)"},
            {w: "David", q: "Jehová es mi pastor (Salmos 23:1)"},
            {w: "Jonás", q: "La salvación es de Jehová (Jonás 2:9)"},
            {w: "Sansón", q: "Su fuerza estaba en su fe (Jueces 16)"},
            {w: "Gólgota", q: "Lugar de la calavera (Mateo 27:33)"},
            {w: "Babel", q: "Confundió Jehová el lenguaje (Génesis 11:9)"}
        ];

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function loginAnonymously() {
            const name = document.getElementById('login-name').value.trim();
            if (!name) return alert("Ingresa tu nombre");
            auth.signInAnonymously().then(cred => {
                currentUser = { uid: cred.user.uid, name: name };
                showScreen('screen-menu');
            });
        }

        async function createRoom() {
            const roomId = Math.random().toString(36).substring(2, 7).toUpperCase();
            currentRoomId = roomId;
            isHost = true;
            await db.collection('rooms').doc(roomId).set({
                hostId: currentUser.uid,
                status: 'waiting',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('room-code-display').innerText = roomId;
            joinRoomLogic(roomId);
            showScreen('screen-create-room');
        }

        async function joinRoom() {
            const code = document.getElementById('join-code-input').value.trim().toUpperCase();
            if (!code) return;
            const doc = await db.collection('rooms').doc(code).get();
            if (!doc.exists) return alert("Sala no encontrada");
            currentRoomId = code;
            isHost = false;
            joinRoomLogic(code);
            showScreen('screen-lobby-guest');
        }

        function joinRoomLogic(roomId) {
            db.collection('rooms').doc(roomId).collection('players').doc(currentUser.uid).set({
                name: currentUser.name,
                uid: currentUser.uid,
                clue: "",
                role: ""
            });
            listenToRoom(roomId);
        }

        function listenToRoom(roomId) {
            // Escuchar cambios en la sala (estados)
            roomUnsub = db.collection('rooms').doc(roomId).onSnapshot(doc => {
                const data = doc.data();
                if (!data) return;
                if (data.status === 'playing') setupPlayerRole(data);
                if (data.status === 'timer') {
                    showScreen('screen-board');
                    startLocalTimer(data.endTime);
                }
                if (data.status === 'voting') setupVoting();
                if (data.status === 'result') showResults(data);
            });

            // Escuchar cambios en los jugadores (lista y pistas)
            playersUnsub = db.collection('rooms').doc(roomId).collection('players').onSnapshot(snap => {
                let html = "";
                snap.forEach(pDoc => {
                    const p = pDoc.data();
                    html += `<div class="player-badge"><i class="fas fa-user"></i> ${p.name}</div>`;
                });
                document.getElementById('lobby-players-host').innerHTML = html;
                document.getElementById('lobby-players-guest').innerHTML = html;
                
                if (document.getElementById('screen-board').classList.contains('active')) {
                    renderCluesGrid(snap);
                }
            });
        }

        async function hostStartGame() {
            const snap = await db.collection('rooms').doc(currentRoomId).collection('players').get();
            if (snap.size < 3) return alert("Mínimo 3 jugadores");

            const ids = snap.docs.map(d => d.id);
            const impId = ids[Math.floor(Math.random() * ids.length)];
            const phrase = phrases[Math.floor(Math.random() * phrases.length)];

            await db.collection('rooms').doc(currentRoomId).update({
                status: 'playing',
                impostorId: impId,
                phrase: phrase.w,
                quote: phrase.q
            });

            snap.forEach(pDoc => {
                pDoc.ref.update({ role: pDoc.id === impId ? 'impostor' : 'believer' });
            });
        }

        async function setupPlayerRole(roomData) {
            const pDoc = await db.collection('rooms').doc(currentRoomId).collection('players').doc(currentUser.uid).get();
            const isImp = pDoc.data().role === 'impostor';
            
            document.getElementById('role-title').innerText = isImp ? "ERES EL FALSO PROFETA" : "ERES CREYENTE";
            document.getElementById('secret-word').innerText = isImp ? "¡INFÍLTRATE!" : roomData.phrase;
            document.getElementById('secret-quote').innerText = isImp ? "No conoces la palabra. Escucha las pistas y miente." : roomData.quote;
            showScreen('screen-reveal');
        }

        async function sendClue() {
            const val = document.getElementById('clue-input').value.trim();
            if (!val || val.split(/\s+/).length > 2) return alert("Máximo 2 palabras");

            await db.collection('rooms').doc(currentRoomId).collection('players').doc(currentUser.uid).update({ clue: val });
            
            if (isHost) {
                const endTime = Date.now() + (5 * 60 * 1000);
                db.collection('rooms').doc(currentRoomId).update({ status: 'timer', endTime: endTime });
            }
        }

        function renderCluesGrid(snap) {
            let html = "";
            snap.forEach(doc => {
                const p = doc.data();
                html += `
                    <div class="glass-card" style="padding:10px;">
                        <div style="font-size:10px; opacity:0.6;">${p.name}</div>
                        <div class="clue-box">${p.clue || '...'}</div>
                    </div>`;
            });
            document.getElementById('players-clues-grid').innerHTML = html;
        }

        function startLocalTimer(endTime) {
            const timerDiv = document.getElementById('timer');
            const timerInt = setInterval(() => {
                const diff = endTime - Date.now();
                if (diff <= 0) {
                    clearInterval(timerInt);
                    if (isHost) db.collection('rooms').doc(currentRoomId).update({ status: 'voting' });
                }
                const m = Math.floor(diff / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                timerDiv.innerText = `${m}:${s < 10 ? '0'+s : s}`;
            }, 1000);
        }

        async function setupVoting() {
            const snap = await db.collection('rooms').doc(currentRoomId).collection('players').get();
            let html = "";
            snap.forEach(doc => {
                if (doc.id !== currentUser.uid) {
                    html += `<button class="btn btn-gold" onclick="castVote('${doc.id}')">${doc.data().name}</button>`;
                }
            });
            document.getElementById('vote-list').innerHTML = html;
            showScreen('screen-vote');
        }

        async function castVote(targetId) {
            await db.collection('rooms').doc(currentRoomId).collection('players').doc(currentUser.uid).update({ vote: targetId });
            if (isHost) {
                setTimeout(async () => {
                    const rSnap = await db.collection('rooms').doc(currentRoomId).get();
                    const pSnap = await db.collection('rooms').doc(currentRoomId).collection('players').get();
                    let votes = {};
                    pSnap.forEach(p => { const v = p.data().vote; if(v) votes[v] = (votes[v] || 0) + 1; });
                    let winnerId = Object.keys(votes).reduce((a, b) => votes[a] > votes[b] ? a : b);
                    db.collection('rooms').doc(currentRoomId).update({
                        status: 'result',
                        winner: winnerId === rSnap.data().impostorId ? 'BELIEVERS' : 'IMPOSTOR',
                        impostorName: pSnap.docs.find(d => d.id === rSnap.data().impostorId).data().name
                    });
                }, 4000);
            }
        }

        function showResults(data) {
            document.getElementById('result-status').innerText = data.winner === 'BELIEVERS' ? "¡LO DESCUBRIERON!" : "¡EL PROFETA LOS ENGAÑÓ!";
            document.getElementById('reveal-impostor-name').innerText = data.impostorName;
            showScreen('screen-result');
        }

        function logout() { auth.signOut().then(() => location.reload()); }
    </script>
</body>
</html>
