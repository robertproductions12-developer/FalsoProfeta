<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Falso Profeta Online</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --gold: #e2b04a;
            --gold-dark: #b8860b;
            --bg: #050505;
            --card: rgba(15, 15, 15, 0.98);
            --accent: #ff3e3e;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg);
            color: white;
            height: 100vh;
            overflow: hidden;
            background: radial-gradient(circle at center, #1a150a 0%, #050505 100%);
        }

        .social-container {
            position: fixed;
            bottom: 45px;
            left: 0; width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 100;
        }
        .social-link {
            width: 35px; height: 35px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--gold-dark);
            text-decoration: none;
        }

        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%; width: 100%;
            padding: 15px;
            text-align: center;
            position: absolute;
        }
        .active { display: flex; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .glass-card {
            background: var(--card);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 25px;
            padding: 20px;
            width: 100%; max-width: 380px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.8);
            max-height: 85vh;
            overflow-y: auto;
        }

        .btn {
            background: linear-gradient(135deg, #222 0%, #000 100%);
            border: 1px solid var(--gold-dark);
            color: white;
            padding: 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            width: 100%;
            margin: 5px 0;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-gold { background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); color: black; border: none; }
        .btn-exit { border-color: var(--accent); color: var(--accent); }

        input[type="text"] {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px; border-radius: 12px;
            color: white; width: 100%; margin-bottom: 10px;
            text-align: center; font-size: 16px;
        }

        .chat-box {
            width: 100%; height: 30vh;
            overflow-y: auto;
            margin: 10px 0;
            display: flex; flex-direction: column; gap: 5px;
            padding: 10px; background: rgba(0,0,0,0.3);
            border-radius: 15px;
        }
        .message {
            font-size: 11px; padding: 6px 10px;
            border-radius: 8px; text-align: left;
            background: rgba(255,255,255,0.05);
            border-left: 3px solid var(--gold);
        }
        .message.my-message { border-left-color: #fff; background: rgba(255,255,255,0.1); }
        .message b { color: var(--gold); font-size: 9px; display: block; }

        #timer { font-size: 40px; font-weight: 900; color: var(--gold); }
        
        #vote-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            max-height: 40vh;
            overflow-y: auto;
            padding: 5px;
        }

        footer { position: fixed; bottom: 10px; width: 100%; text-align: center; font-size: 8px; opacity: 0.4; }
        #video-intro { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; opacity: 0.2; }
    </style>
</head>
<body>

    <video id="video-intro" autoplay muted loop playsinline>
        <source src="logo_animado.mp4" type="video/mp4">
    </video>

    <div class="social-container">
        <a href="https://youtube.com/@robert_paraco" class="social-link" target="_blank"><i class="fab fa-youtube"></i></a>
        <a href="https://instagram.com/robert_paraco" class="social-link" target="_blank"><i class="fab fa-instagram"></i></a>
        <a href="https://tiktok.com/@robert_paraco" class="social-link" target="_blank"><i class="fab fa-tiktok"></i></a>
    </div>

    <!-- PANTALLAS -->
    <div id="screen-login" class="screen active">
        <div class="glass-card">
            <h2 style="color:var(--gold); margin-bottom: 15px;">EL FALSO PROFETA</h2>
            <input type="text" id="login-name" placeholder="Tu nombre...">
            <button class="btn btn-gold" onclick="login()">ENTRAR</button>
        </div>
    </div>

    <div id="screen-menu" class="screen">
        <div class="glass-card">
            <button class="btn btn-gold" onclick="createRoom()">CREAR SALA ONLINE</button>
            <button class="btn" onclick="showScreen('screen-join-room')">UNIRSE A SALA</button>
        </div>
    </div>

    <div id="screen-create-room" class="screen">
        <div class="glass-card">
            <h2 style="color:var(--gold)">CÃ“DIGO: <span id="room-code-display">---</span></h2>
            <div id="lobby-players" style="margin: 15px 0; text-align: left; font-size: 12px;"></div>
            <button class="btn btn-gold" onclick="startPrep()">INICIAR PARTIDA</button>
            <button class="btn btn-exit" onclick="location.reload()">SALIR</button>
        </div>
    </div>

    <div id="screen-join-room" class="screen">
        <div class="glass-card">
            <input type="text" id="join-code-input" placeholder="CÃ“DIGO DE SALA" style="text-transform: uppercase;">
            <button class="btn btn-gold" onclick="joinRoom()">UNIRSE</button>
            <button class="btn" onclick="showScreen('screen-menu')">VOLVER</button>
        </div>
    </div>

    <div id="screen-lobby-guest" class="screen">
        <div class="glass-card">
            <h2 style="color:var(--gold)">ESPERANDO...</h2>
            <div id="lobby-players-guest" style="margin: 15px 0; text-align: left; font-size: 12px;"></div>
        </div>
    </div>

    <div id="screen-prep" class="screen">
        <div class="glass-card">
            <h2 style="color:var(--gold)">PREPARANDO...</h2>
            <div id="prep-timer" style="font-size: 50px; font-weight: 900;">15</div>
        </div>
    </div>

    <div id="screen-reveal" class="screen">
        <div class="glass-card">
            <h2 id="role-title">TU ROL</h2>
            <div id="secret-word" style="font-size: 24px; color: var(--gold); margin: 15px 0; font-weight: 900;">---</div>
            <p id="secret-quote" style="font-style: italic; font-size: 12px; opacity: 0.8;"></p>
            <button class="btn btn-gold" style="margin-top: 15px;" onclick="confirmRole()">ENTENDIDO</button>
        </div>
    </div>

    <div id="screen-clues" class="screen">
        <div id="timer">02:00</div>
        <div id="turn-indicator" style="font-size: 11px; color: var(--gold); margin-bottom: 5px;">CARGANDO...</div>
        <div id="chat-area" class="chat-box"></div>
        <div id="clue-input-area" style="display:none; width: 100%; max-width: 340px;">
            <input type="text" id="clue-input" placeholder="2 PALABRAS MÃXIMO">
            <button class="btn btn-gold" onclick="sendClue()">ENVIAR PISTA</button>
        </div>
        <p id="wait-turn-msg" style="font-size: 10px; opacity: 0.5;">Espera tu turno...</p>
    </div>

    <div id="screen-vote" class="screen">
        <div class="glass-card">
            <h3 style="color: var(--accent); margin-bottom: 10px;">VOTACIÃ“N</h3>
            <p style="font-size: 10px; margin-bottom: 10px;">Â¿QuiÃ©n es el Falso Profeta?</p>
            <div id="vote-grid"></div>
            <p id="vote-wait-msg" style="margin-top: 10px; font-size: 10px; color: var(--gold); display:none;">Esperando a los demÃ¡s...</p>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div class="glass-card">
            <h2 id="res-status">-</h2>
            <p style="font-size: 10px; opacity: 0.6; margin-top: 10px;">EL FALSO PROFETA ERA:</p>
            <h1 id="res-impostor" style="color: var(--gold); font-size: 24px;">---</h1>
            <div id="vote-summary" style="font-size: 10px; margin: 15px 0; text-align: left; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 10px;"></div>
            <button class="btn btn-gold" onclick="location.reload()">JUGAR DE NUEVO</button>
        </div>
    </div>

    <footer>DISEÃ‘ADO POR - ROBERT PARACO</footer>

    <script>
        // CONFIGURACIÃ“N FIREBASE
        const firebaseConfig = {
             apiKey: "AIzaSyCc0dMjTppOlnGV_NuXCFUGhx7882qbZlE",
             authDomain: "falsoprofeta-6e682.firebaseapp.com",
             projectId: "falsoprofeta-6e682",
             storageBucket: "falsoprofeta-6e682.firebasestorage.app",
             messagingSenderId: "480777785862",
             appId: "1:480777785862:web:8c5886c6e9a2d132356987"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // 100 PERSONAJES, HISTORIAS, LUGARES Y PARÃBOLAS
        const biblicalItems = [
            // PERSONAJES (40)
            {w: "AdÃ¡n", q: "Formado del polvo de la tierra (GÃ©nesis 2:7)"}, {w: "Eva", q: "Madre de todos los vivientes (GÃ©nesis 3:20)"},
            {w: "NoÃ©", q: "VarÃ³n justoâ€¦ caminÃ³ con Dios (GÃ©nesis 6:9)"}, {w: "Abraham", q: "Sal de tu tierra (GÃ©nesis 12:1)"},
            {w: "Isaac", q: "Dios proveerÃ¡ (GÃ©nesis 22:8)"}, {w: "Jacob", q: "He visto a Dios cara a cara (GÃ©nesis 32:30)"},
            {w: "JosÃ©", q: "Dios lo encaminÃ³ a bien (GÃ©nesis 50:20)"}, {w: "MoisÃ©s", q: "Yo estarÃ© contigo (Ã‰xodo 3:12)"},
            {w: "AarÃ³n", q: "SerÃ¡ tu portavoz (Ã‰xodo 4:16)"}, {w: "JosuÃ©", q: "EsfuÃ©rzate y sÃ© valiente (JosuÃ© 1:9)"},
            {w: "DÃ©bora", q: "Se levantÃ³ como madre en Israel (Jueces 5:7)"}, {w: "GedeÃ³n", q: "JehovÃ¡ estÃ¡ contigo (Jueces 6:12)"},
            {w: "SansÃ³n", q: "ComenzÃ³ a salvar a Israel (Jueces 13:5)"}, {w: "Rut", q: "Tu Dios serÃ¡ mi Dios (Rut 1:16)"},
            {w: "Samuel", q: "Habla, porque tu siervo oye (1 Samuel 3:10)"}, {w: "SaÃºl", q: "Otro corazÃ³n le fue dado (1 Samuel 10:9)"},
            {w: "David", q: "JehovÃ¡ es mi pastor (Salmos 23:1)"}, {w: "SalomÃ³n", q: "Dame sabidurÃ­a (1 Reyes 3:9)"},
            {w: "ElÃ­as", q: "Vive JehovÃ¡ (1 Reyes 17:1)"}, {w: "Eliseo", q: "Una doble porciÃ³n de tu espÃ­ritu (2 Reyes 2:9)"},
            {w: "IsaÃ­as", q: "Heme aquÃ­, envÃ­ame a mÃ­ (IsaÃ­as 6:8)"}, {w: "JeremÃ­as", q: "Antes que nacieses te conocÃ­ (JeremÃ­as 1:5)"},
            {w: "Ezequiel", q: "Hijo de hombre, ponte en pie (Ezequiel 2:1)"}, {w: "Daniel", q: "Dios cerrÃ³ la boca de los leones (Daniel 6:22)"},
            {w: "Ester", q: "Para esta hora has llegado (Ester 4:14)"}, {w: "NehemÃ­as", q: "El gozo de JehovÃ¡ es mi fuerza (NehemÃ­as 8:10)"},
            {w: "Job", q: "Yo sÃ© que mi Redentor vive (Job 19:25)"}, {w: "JonÃ¡s", q: "La salvaciÃ³n es de JehovÃ¡ (JonÃ¡s 2:9)"},
            {w: "ZacarÃ­as", q: "No con ejÃ©rcito ni con fuerza (ZacarÃ­as 4:6)"}, {w: "Juan el Bautista", q: "Preparad el camino del SeÃ±or (Mateo 3:3)"},
            {w: "MarÃ­a", q: "He aquÃ­ la sierva del SeÃ±or (Lucas 1:38)"}, {w: "JosÃ© (Esposo)", q: "No temas recibir a MarÃ­a (Mateo 1:20)"},
            {w: "Pedro", q: "TÃº eres el Cristo (Mateo 16:16)"}, {w: "Juan", q: "El discÃ­pulo amado (Juan 13:23)"},
            {w: "Marta", q: "Yo sÃ© que resucitarÃ¡ (Juan 11:24)"}, {w: "MarÃ­a Magdalena", q: "He visto al SeÃ±or (Juan 20:18)"},
            {w: "Pablo", q: "Todo lo puedo en Cristo (Filipenses 4:13)"}, {w: "BernabÃ©", q: "Hijo de consolaciÃ³n (Hechos 4:36)"},
            {w: "Timoteo", q: "Ninguno tenga en poco tu juventud (1 Timoteo 4:12)"}, {w: "JesÃºs", q: "Yo soy el camino, la verdad y la vida (Juan 14:6)"},
            
            // HISTORIAS (20)
            {w: "La creaciÃ³n", q: "Y vio Dios que era bueno (GÃ©nesis 1:31)"}, {w: "El diluvio", q: "EntrÃ³ NoÃ© en el arca (GÃ©nesis 7:7)"},
            {w: "Torre de Babel", q: "ConfundiÃ³ JehovÃ¡ el lenguaje (GÃ©nesis 11:9)"}, {w: "Sacrificio Isaac", q: "JehovÃ¡ proveerÃ¡ (GÃ©nesis 22:14)"},
            {w: "JosÃ© vendido", q: "Lo vendieron por plata (GÃ©nesis 37:28)"}, {w: "El Ã©xodo", q: "Deja ir a mi pueblo (Ã‰xodo 5:1)"},
            {w: "Mar Rojo", q: "Las aguas se abrieron (Ã‰xodo 14:21)"}, {w: "El manÃ¡", q: "Pan del cielo (Ã‰xodo 16:4)"},
            {w: "10 Mandamientos", q: "Escritos por el dedo de Dios (Ã‰xodo 31:18)"}, {w: "CaÃ­da de JericÃ³", q: "El muro se derrumbÃ³ (JosuÃ© 6:20)"},
            {w: "David y Goliat", q: "JehovÃ¡ te entregarÃ¡ (1 Samuel 17:46)"}, {w: "Templo SalomÃ³n", q: "La gloria de JehovÃ¡ llenÃ³ la casa (1 Reyes 8:11)"},
            {w: "ElÃ­as en Carmelo", q: "JehovÃ¡ es Dios (1 Reyes 18:39)"}, {w: "JonÃ¡s y el pez", q: "JehovÃ¡ hablÃ³ al pez (JonÃ¡s 2:10)"},
            {w: "Horno de fuego", q: "No fueron quemados (Daniel 3:27)"}, {w: "Foso de leones", q: "Dios enviÃ³ su Ã¡ngel (Daniel 6:22)"},
            {w: "Nacimiento JesÃºs", q: "Os ha nacido un Salvador (Lucas 2:11)"}, {w: "La cruz", q: "Consumado es (Juan 19:30)"},
            {w: "ResurrecciÃ³n", q: "No estÃ¡ aquÃ­, resucitÃ³ (Mateo 28:6)"}, {w: "PentecostÃ©s", q: "Fueron llenos del EspÃ­ritu Santo (Hechos 2:4)"},

            // LUGARES (20)
            {w: "EdÃ©n", q: "PlantÃ³ JehovÃ¡ Dios un huerto (GÃ©nesis 2:8)"}, {w: "Ararat", q: "ReposÃ³ el arca (GÃ©nesis 8:4)"},
            {w: "Betel", q: "Casa de Dios (GÃ©nesis 28:19)"}, {w: "Egipto", q: "Lugar de esclavitud (Ã‰xodo 1:14)"},
            {w: "SinaÃ­", q: "JehovÃ¡ descendiÃ³ (Ã‰xodo 19:20)"}, {w: "JericÃ³", q: "Ciudad fortificada (JosuÃ© 6:1)"},
            {w: "JerusalÃ©n", q: "Ciudad del gran Rey (Salmos 48:2)"}, {w: "BelÃ©n", q: "De ti me saldrÃ¡ el Salvador (Miqueas 5:2)"},
            {w: "Nazaret", q: "SerÃ¡ llamado nazareno (Mateo 2:23)"}, {w: "Galilea", q: "El pueblo vio gran luz (Mateo 4:16)"},
            {w: "Capernaum", q: "Ciudad de JesÃºs (Mateo 9:1)"}, {w: "Samaria", q: "Campo de misiÃ³n (Juan 4:4)"},
            {w: "GetsemanÃ­", q: "OrÃ³ con gran agonÃ­a (Lucas 22:44)"}, {w: "GÃ³lgota", q: "Lugar de la calavera (Mateo 27:33)"},
            {w: "Monte Olivos", q: "AscendiÃ³ al cielo (Hechos 1:9)"}, {w: "Damasco", q: "Camino de conversiÃ³n (Hechos 9:3)"},
            {w: "AntioquÃ­a", q: "Llamados cristianos (Hechos 11:26)"}, {w: "Ã‰feso", q: "Gran puerta abierta (1 Corintios 16:9)"},
            {w: "Corinto", q: "Tengo mucho pueblo (Hechos 18:10)"}, {w: "Patmos", q: "Por causa de la palabra (Apocalipsis 1:9)"},

            // PARÃBOLAS (20)
            {w: "El sembrador", q: "El que oye la palabra (Mateo 13:23)"}, {w: "Trigo y cizaÃ±a", q: "Dejad crecer juntos (Mateo 13:30)"},
            {w: "Grano mostaza", q: "La mÃ¡s pequeÃ±a (Mateo 13:32)"}, {w: "La levadura", q: "LeudÃ³ toda la masa (Mateo 13:33)"},
            {w: "Tesoro escondido", q: "Vende todo lo que tiene (Mateo 13:44)"}, {w: "Perla gran precio", q: "Una perla preciosa (Mateo 13:46)"},
            {w: "La red", q: "Separan a los malos (Mateo 13:49)"}, {w: "La oveja perdida", q: "Hasta hallarla (Lucas 15:4)"},
            {w: "Moneda perdida", q: "Se goza cuando la halla (Lucas 15:9)"}, {w: "Hijo prÃ³digo", q: "Estaba muerto y reviviÃ³ (Lucas 15:24)"},
            {w: "Buen samaritano", q: "Tuvo compasiÃ³n (Lucas 10:33)"}, {w: "Amigo importuno", q: "Por su insistencia (Lucas 11:8)"},
            {w: "Rico insensato", q: "Esta noche vienen por tu alma (Lucas 12:20)"}, {w: "Higuera estÃ©ril", q: "Dale otra oportunidad (Lucas 13:8)"},
            {w: "Los invitados", q: "Muchos son llamados (Mateo 22:14)"}, {w: "Los talentos", q: "Bien, buen siervo fiel (Mateo 25:21)"},
            {w: "Diez vÃ­rgenes", q: "Velad (Mateo 25:13)"}, {w: "Juicio final", q: "A uno de estos pequeÃ±os (Mateo 25:40)"},
            {w: "Fariseo y Publicano", q: "DescendiÃ³ justificado (Lucas 18:14)"}, {w: "Constructor sabio", q: "Sobre la roca (Mateo 7:24)"}
        ];

        let currentUser = null, currentRoomId = null, isHost = false, timerInterval = null;

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function login() {
            const name = document.getElementById('login-name').value.trim();
            if(!name) return;
            auth.signInAnonymously().then(cred => {
                currentUser = { uid: cred.user.uid, name: name };
                showScreen('screen-menu');
            });
        }

        async function createRoom() {
            const code = Math.random().toString(36).substring(2,7).toUpperCase();
            currentRoomId = code; isHost = true;
            await db.collection('rooms').doc(code).set({
                hostId: currentUser.uid, status: 'waiting', turnIndex: 0, playerOrder: [], createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('room-code-display').innerText = code;
            joinLogic(code); showScreen('screen-create-room');
        }

        function joinRoom() {
            const code = document.getElementById('join-code-input').value.trim().toUpperCase();
            if(!code) return;
            db.collection('rooms').doc(code).get().then(doc => {
                if(!doc.exists) return alert("SALA NO EXISTE");
                currentRoomId = code; isHost = false; joinLogic(code); showScreen('screen-lobby-guest');
            });
        }

        async function joinLogic(code) {
            await db.collection('rooms').doc(code).collection('players').doc(currentUser.uid).set({
                name: currentUser.name, uid: currentUser.uid, vote: "", role: "", joinedAt: Date.now()
            });
            listenRoom(code);
        }

        function listenRoom(code) {
            db.collection('rooms').doc(code).onSnapshot(doc => {
                const data = doc.data(); if(!data) return;
                if(data.status === 'pre-start') handlePreStart(data);
                if(data.status === 'playing') setupRole(data);
                if(data.status === 'clues') handleClues(data);
                if(data.status === 'voting') setupVote();
                if(data.status === 'result') showFinalResult(data);
            });

            db.collection('rooms').doc(code).collection('players').orderBy('joinedAt', 'asc').onSnapshot(snap => {
                let listHtml = "";
                snap.forEach(p => { listHtml += `<div>ðŸ”¹ ${p.data().name}</div>`; });
                document.getElementById('lobby-players').innerHTML = listHtml;
                document.getElementById('lobby-players-guest').innerHTML = listHtml;
            });

            db.collection('rooms').doc(code).collection('chat').orderBy('time', 'asc').onSnapshot(snap => {
                const box = document.getElementById('chat-area');
                box.innerHTML = "";
                snap.forEach(m => {
                    const md = m.data();
                    const div = document.createElement('div');
                    div.className = `message ${md.uid === currentUser.uid ? 'my-message' : ''}`;
                    div.innerHTML = `<b>${md.name}</b> ${md.text}`;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        async function startPrep() {
            const pSnap = await db.collection('rooms').doc(currentRoomId).collection('players').get();
            if(pSnap.size < 3) return alert("MÃNIMO 3 JUGADORES");
            db.collection('rooms').doc(currentRoomId).update({ status: 'pre-start', prepEnd: Date.now() + 15000 });
        }

        function handlePreStart(data) {
            showScreen('screen-prep');
            const timerEl = document.getElementById('prep-timer');
            const intv = setInterval(() => {
                const diff = Math.ceil((data.prepEnd - Date.now()) / 1000);
                timerEl.innerText = diff > 0 ? diff : 0;
                if(diff <= 0) {
                    clearInterval(intv);
                    if(isHost) startGameLogic();
                }
            }, 1000);
        }

        async function startGameLogic() {
            const pSnap = await db.collection('rooms').doc(currentRoomId).collection('players').orderBy('joinedAt', 'asc').get();
            const ids = pSnap.docs.map(d => d.id);
            const impId = ids[Math.floor(Math.random() * ids.length)];
            const chosen = biblicalItems[Math.floor(Math.random() * biblicalItems.length)];
            // TIEMPO AJUSTADO A 2 MINUTOS
            const endTime = Date.now() + (2 * 60 * 1000);

            await db.collection('rooms').doc(currentRoomId).update({
                status: 'playing', impostorId: impId, word: chosen.w, quote: chosen.q,
                playerOrder: ids, turnIndex: 0, endTime: endTime
            });

            pSnap.forEach(pDoc => {
                pDoc.ref.update({ role: pDoc.id === impId ? 'impostor' : 'disciple' });
            });
        }

        async function setupRole(data) {
            const p = await db.collection('rooms').doc(currentRoomId).collection('players').doc(currentUser.uid).get();
            if(!p.exists) return;
            const isImp = p.data().role === 'impostor';
            document.getElementById('role-title').innerText = isImp ? "FALSO PROFETA" : "DISCÃPULO";
            document.getElementById('secret-word').innerText = isImp ? "Â¡ESCÃ“NDETE!" : data.word;
            document.getElementById('secret-quote').innerText = isImp ? "No sabes la palabra. EngaÃ±a a los demÃ¡s." : data.quote;
            showScreen('screen-reveal');
        }

        function confirmRole() {
            if(isHost) db.collection('rooms').doc(currentRoomId).update({ status: 'clues' });
            else showScreen('screen-clues');
        }

        function handleClues(data) {
            showScreen('screen-clues');
            if(!timerInterval) startDebateTimer(data.endTime);

            const turnUid = data.playerOrder[data.turnIndex];
            const isMyTurn = (turnUid === currentUser.uid);

            db.collection('rooms').doc(currentRoomId).collection('players').doc(turnUid).get().then(d => {
                if(d.exists) document.getElementById('turn-indicator').innerText = `TURNO DE: ${d.data().name.toUpperCase()}`;
            });

            document.getElementById('clue-input-area').style.display = isMyTurn ? 'block' : 'none';
            document.getElementById('wait-turn-msg').style.display = isMyTurn ? 'none' : 'block';
            if(isMyTurn) document.getElementById('clue-input').focus();
        }

        async function sendClue() {
            const input = document.getElementById('clue-input');
            const val = input.value.trim();
            if(!val || val.split(/\s+/).length > 2) return alert("MÃXIMO 2 PALABRAS");

            await db.collection('rooms').doc(currentRoomId).collection('chat').add({
                name: currentUser.name, uid: currentUser.uid, text: val.toUpperCase(), time: Date.now()
            });

            input.value = "";
            const rDoc = await db.collection('rooms').doc(currentRoomId).get();
            const rData = rDoc.data();
            let nextIdx = (rData.turnIndex + 1) % rData.playerOrder.length; // CICLO INFINITO

            db.collection('rooms').doc(currentRoomId).update({ turnIndex: nextIdx });
        }

        function startDebateTimer(endTime) {
            const timerEl = document.getElementById('timer');
            timerInterval = setInterval(() => {
                const diff = endTime - Date.now();
                if(diff <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    if(isHost) db.collection('rooms').doc(currentRoomId).update({ status: 'voting' });
                    return;
                }
                const m = Math.floor(diff / 60000), s = Math.floor((diff % 60000) / 1000);
                timerEl.innerText = `${m}:${s < 10 ? '0'+s : s}`;
            }, 1000);
        }

        async function setupVote() {
            const pSnap = await db.collection('rooms').doc(currentRoomId).collection('players').get();
            let html = "";
            pSnap.forEach(p => {
                if(p.id !== currentUser.uid) {
                    html += `<button class="btn btn-gold" style="font-size:9px;" onclick="castVote('${p.id}')">${p.data().name}</button>`;
                }
            });
            document.getElementById('vote-grid').innerHTML = html;
            showScreen('screen-vote');
        }

        async function castVote(targetId) {
            document.getElementById('vote-grid').style.pointerEvents = 'none';
            document.getElementById('vote-wait-msg').style.display = 'block';
            await db.collection('rooms').doc(currentRoomId).collection('players').doc(currentUser.uid).update({ vote: targetId });
            
            if(isHost) checkAllVotes();
        }

        async function checkAllVotes() {
            const players = await db.collection('rooms').doc(currentRoomId).collection('players').get();
            const allVoted = players.docs.every(d => d.data().vote !== "");
            
            if(allVoted) {
                const rData = (await db.collection('rooms').doc(currentRoomId).get()).data();
                let votesCount = {}, summary = "";
                
                players.forEach(p => {
                    const d = p.data();
                    const votedTo = players.docs.find(x => x.id === d.vote)?.data().name || "---";
                    summary += `<div><b>${d.name}</b> votÃ³ a: ${votedTo}</div>`;
                    votesCount[d.vote] = (votesCount[d.vote] || 0) + 1;
                });

                // Encontrar el mÃ¡s votado
                let mostVotedId = Object.keys(votesCount).reduce((a, b) => votesCount[a] > votesCount[b] ? a : b);
                let winner = (mostVotedId === rData.impostorId) ? 'DISCIPLES' : 'IMPOSTOR';
                let impName = players.docs.find(x => x.id === rData.impostorId).data().name;

                db.collection('rooms').doc(currentRoomId).update({
                    status: 'result', winner: winner, summary: summary, impostorName: impName
                });
            } else {
                setTimeout(checkAllVotes, 2000);
            }
        }

        function showFinalResult(data) {
            const statusEl = document.getElementById('res-status');
            statusEl.innerText = data.winner === 'DISCIPLES' ? "Â¡LOGRARON EXPULSARLO!" : "Â¡EL PROFETA LOS ENGAÃ‘Ã“!";
            statusEl.style.color = data.winner === 'DISCIPLES' ? "var(--gold)" : "var(--accent)";
            document.getElementById('res-impostor').innerText = data.impostorName;
            document.getElementById('vote-summary').innerHTML = data.summary;
            showScreen('screen-result');
        }
    </script>
</body>
</html>
