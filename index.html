<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Falso Profeta - Edici√≥n Online</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --gold: #e2b04a;
            --gold-dark: #b8860b;
            --bg: #050505;
            --card: rgba(15, 15, 15, 0.95);
            --accent: #ff3e3e;
            --transition: all 0.4s ease;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg);
            color: white;
            height: 100vh;
            overflow: hidden;
            background: radial-gradient(circle at center, #1a150a 0%, #050505 100%);
        }

        /* --- REDES SOCIALES ABAJO --- */
        .social-footer {
            position: fixed;
            bottom: 40px;
            left: 0; width: 100%;
            display: flex;
            justify-content: center;
            gap: 25px;
            z-index: 100;
        }
        .social-icon {
            width: 45px; height: 45px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 20px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(226, 176, 74, 0.3);
            text-decoration: none;
            transition: var(--transition);
        }
        .social-icon:hover { background: var(--gold); color: black; transform: translateY(-5px); }

        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%; width: 100%;
            padding: 20px;
            text-align: center;
            position: absolute;
        }
        .active { display: flex; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .glass-card {
            background: var(--card);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 25px;
            padding: 25px;
            width: 100%; max-width: 360px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .btn {
            background: linear-gradient(135deg, #222 0%, #000 100%);
            border: 1px solid var(--gold-dark);
            color: white;
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            width: 100%;
            margin: 5px 0;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-gold { background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); color: black; border: none; }
        .btn-exit { background: #330000; border: 1px solid var(--accent); color: var(--accent); }

        input[type="text"] {
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 15px; border-radius: 12px;
            color: white; width: 100%; margin-bottom: 10px;
            text-align: center; font-size: 16px;
        }

        .clue-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 10px; width: 100%; max-height: 40vh;
            overflow-y: auto; margin: 15px 0;
        }
        .clue-item {
            background: rgba(255,255,255,0.05);
            padding: 10px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .clue-item.active-turn { border: 2px solid var(--gold); background: rgba(226,176,74,0.1); }
        .clue-text { color: var(--gold); font-weight: 900; font-size: 13px; margin-top: 5px; }

        #timer, #prep-timer { font-size: 50px; font-weight: 900; color: var(--gold); margin: 10px 0; }
        
        #video-intro { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; opacity: 0.3; }
        
        footer { position: fixed; bottom: 10px; width: 100%; text-align: center; font-size: 8px; opacity: 0.5; letter-spacing: 2px; }
    </style>
</head>
<body>

    <video id="video-intro" autoplay muted loop playsinline>
        <source src="logo_animado.mp4" type="video/mp4">
    </video>

    <!-- REDES SOCIALES ABAJO -->
    <div class="social-footer">
        <a href="https://youtube.com/@robert_paraco" class="social-icon" target="_blank"><i class="fab fa-youtube"></i></a>
        <a href="https://instagram.com/robert_paraco" class="social-icon" target="_blank"><i class="fab fa-instagram"></i></a>
        <a href="https://tiktok.com/@robert_paraco" class="social-icon" target="_blank"><i class="fab fa-tiktok"></i></a>
    </div>

    <!-- 1. LOGIN -->
    <div id="screen-login" class="screen active">
        <div class="glass-card">
            <h1 style="color:var(--gold); font-size: 1.8rem; margin-bottom: 20px;">EL FALSO PROFETA</h1>
            <input type="text" id="login-name" placeholder="Escribe tu Nombre">
            <button class="btn btn-gold" onclick="login()">ENTRAR</button>
        </div>
    </div>

    <!-- 2. MENU -->
    <div id="screen-menu" class="screen">
        <div class="glass-card">
            <button class="btn btn-gold" onclick="createRoom()">CREAR PARTIDA ONLINE</button>
            <button class="btn" onclick="showScreen('screen-join-room')">UNIRSE A SALA</button>
            <button class="btn btn-exit" onclick="location.reload()">SALIR DEL JUEGO</button>
        </div>
    </div>

    <!-- 3. LOBBY HOST -->
    <div id="screen-create-room" class="screen">
        <div class="glass-card">
            <h2 style="color:var(--gold)">SALA: <span id="room-code-display">---</span></h2>
            <div id="lobby-players" style="margin: 20px 0; text-align: left;"></div>
            <button class="btn btn-gold" onclick="startPrep()">INICIAR PARTIDA</button>
            <button class="btn btn-exit" onclick="exitRoom()">CERRAR SALA</button>
        </div>
    </div>

    <!-- 4. UNIRSE -->
    <div id="screen-join-room" class="screen">
        <div class="glass-card">
            <input type="text" id="join-code-input" placeholder="C√ìDIGO DE SALA" style="text-transform: uppercase;">
            <button class="btn btn-gold" onclick="joinRoom()">UNIRSE</button>
            <button class="btn" onclick="showScreen('screen-menu')">VOLVER</button>
        </div>
    </div>

    <!-- 5. LOBBY ESPERA (GUEST) -->
    <div id="screen-lobby-guest" class="screen">
        <div class="glass-card">
            <h2 style="color:var(--gold)">EN LA SALA</h2>
            <div id="lobby-players-guest" style="margin: 20px 0;"></div>
            <button class="btn btn-exit" onclick="exitRoom()">SALIR</button>
        </div>
    </div>

    <!-- 6. PREPARACI√ìN (15 SEG) -->
    <div id="screen-prep" class="screen">
        <div class="glass-card">
            <h2 style="color:var(--gold)">PREPARANDO...</h2>
            <div id="prep-timer">15</div>
            <p>Se est√°n revelando las profec√≠as...</p>
        </div>
    </div>

    <!-- 7. ROL -->
    <div id="screen-reveal" class="screen">
        <div class="glass-card">
            <h2 id="role-title">TU ROL</h2>
            <div id="secret-word" style="font-size: 26px; color: var(--gold); margin: 20px 0; font-weight: 900;">---</div>
            <p id="secret-quote" style="font-style: italic; font-size: 13px; opacity: 0.8;"></p>
            <button class="btn btn-gold" style="margin-top: 20px;" onclick="confirmRole()">ENTENDIDO</button>
        </div>
    </div>

    <!-- 8. PISTAS Y CHAT -->
    <div id="screen-clues" class="screen">
        <div id="timer">03:00</div>
        <h3 id="clue-turn-msg" style="color: var(--gold); margin-bottom: 10px; font-size: 14px;">-</h3>
        <div id="clues-grid" class="clue-grid"></div>
        <div id="my-clue-input-area" style="display:none; width: 100%; max-width: 340px;">
            <input type="text" id="clue-input" placeholder="2 PALABRAS M√ÅX">
            <button class="btn btn-gold" onclick="submitClue()">ENVIAR PISTA</button>
        </div>
    </div>

    <!-- 9. VOTACI√ìN -->
    <div id="screen-vote" class="screen">
        <h2 style="color: var(--accent); margin-bottom: 15px;">VOTACI√ìN</h2>
        <div id="vote-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 400px;"></div>
        <p id="vote-wait-msg" style="margin-top: 15px; font-size: 12px; display: none;">Esperando que todos voten...</p>
    </div>

    <!-- 10. RESULTADO -->
    <div id="screen-result" class="screen">
        <div class="glass-card">
            <h2 id="res-status">-</h2>
            <p style="font-size: 11px; opacity: 0.6; margin-top: 10px;">EL FALSO PROFETA ERA:</p>
            <h1 id="res-impostor" style="color: var(--gold); margin: 10px 0;">---</h1>
            <div id="vote-summary" style="font-size: 10px; margin: 15px 0; text-align: left; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px;"></div>
            <button class="btn btn-gold" onclick="location.reload()">VOLVER AL MEN√ö</button>
        </div>
    </div>

    <footer>DISE√ëADO POR - ROBERT PARACO</footer>

    <script>
        const firebaseConfig = {
             apiKey: "AIzaSyCc0dMjTppOlnGV_NuXCFUGhx7882qbZlE",
             authDomain: "falsoprofeta-6e682.firebaseapp.com",
             projectId: "falsoprofeta-6e682",
             storageBucket: "falsoprofeta-6e682.firebasestorage.app",
             messagingSenderId: "480777785862",
             appId: "1:480777785862:web:8c5886c6e9a2d132356987"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const items = [
            {w: "Ad√°n", q: "Formado del polvo de la tierra (G√©nesis 2:7)"}, {w: "Eva", q: "Madre de todos los vivientes (G√©nesis 3:20)"},
            {w: "No√©", q: "Var√≥n justo‚Ä¶ camin√≥ con Dios (G√©nesis 6:9)"}, {w: "Abraham", q: "Sal de tu tierra (G√©nesis 12:1)"},
            {w: "Isaac", q: "Dios proveer√° (G√©nesis 22:8)"}, {w: "Jacob", q: "He visto a Dios cara a cara (G√©nesis 32:30)"},
            {w: "Jos√©", q: "Dios lo encamin√≥ a bien (G√©nesis 50:20)"}, {w: "Mois√©s", q: "Yo estar√© contigo (√âxodo 3:12)"},
            {w: "Aar√≥n", q: "Ser√° tu portavoz (√âxodo 4:16)"}, {w: "Josu√©", q: "Esfu√©rzate y s√© valiente (Josu√© 1:9)"},
            {w: "D√©bora", q: "Se levant√≥ como madre en Israel (Jueces 5:7)"}, {w: "Gede√≥n", q: "Jehov√° est√° contigo (Jueces 6:12)"},
            {w: "Sans√≥n", q: "Comenz√≥ a salvar a Israel (Jueces 13:5)"}, {w: "Rut", q: "Tu Dios ser√° mi Dios (Rut 1:16)"},
            {w: "Samuel", q: "Habla, porque tu siervo oye (1 Samuel 3:10)"}, {w: "Sa√∫l", q: "Otro coraz√≥n le fue dado (1 Samuel 10:9)"},
            {w: "David", q: "Jehov√° es mi pastor (Salmos 23:1)"}, {w: "Salom√≥n", q: "Dame sabidur√≠a (1 Reyes 3:9)"},
            {w: "El√≠as", q: "Vive Jehov√° (1 Reyes 17:1)"}, {w: "Eliseo", q: "Una doble porci√≥n de tu esp√≠ritu (2 Reyes 2:9)"},
            {w: "Isa√≠as", q: "Heme aqu√≠, env√≠ame a m√≠ (Isa√≠as 6:8)"}, {w: "Jerem√≠as", q: "Antes que nacieses te conoc√≠ (Jerem√≠as 1:5)"},
            {w: "Ezequiel", q: "Hijo de hombre, ponte en pie (Ezequiel 2:1)"}, {w: "Daniel", q: "Dios cerr√≥ la boca de los leones (Daniel 6:22)"},
            {w: "Ester", q: "Para esta hora has llegado (Ester 4:14)"}, {w: "Nehem√≠as", q: "El gozo de Jehov√° es mi fuerza (Nehem√≠as 8:10)"},
            {w: "Job", q: "Yo s√© que mi Redentor vive (Job 19:25)"}, {w: "Jon√°s", q: "La salvaci√≥n es de Jehov√° (Jon√°s 2:9)"},
            {w: "Zacar√≠as", q: "No con ej√©rcito ni con fuerza (Zacar√≠as 4:6)"}, {w: "Juan el Bautista", q: "Preparad el camino del Se√±or (Mateo 3:3)"},
            {w: "Mar√≠a", q: "He aqu√≠ la sierva del Se√±or (Lucas 1:38)"}, {w: "Pedro", q: "T√∫ eres el Cristo (Mateo 16:16)"},
            {w: "Jes√∫s", q: "Yo soy el camino, la verdad y la vida (Juan 14:6)"},
            {w: "La creaci√≥n", q: "Y vio Dios que era bueno (G√©nesis 1:31)"}, {w: "El diluvio", q: "Entr√≥ No√© en el arca (G√©nesis 7:7)"},
            {w: "David y Goliat", q: "Jehov√° te entregar√° (1 Samuel 17:46)"}, {w: "El mar Rojo", q: "Las aguas se abrieron (√âxodo 14:21)"},
            {w: "Getseman√≠", q: "Or√≥ con gran agon√≠a (Lucas 22:44)"}, {w: "G√≥lgota", q: "Lugar de la calavera (Mateo 27:33)"},
            {w: "El hijo pr√≥digo", q: "Estaba muerto y revivi√≥ (Lucas 15:24)"}, {w: "Las diez v√≠rgenes", q: "Velad (Mateo 25:13)"}
            // (Se pueden a√±adir los dem√°s respetando el formato {w: "", q: ""})
        ];

        let currentUser = null, currentRoomId = null, isHost = false, roomUnsub = null, playersUnsub = null;

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function login() {
            const name = document.getElementById('login-name').value.trim();
            if(!name) return;
            auth.signInAnonymously().then(cred => {
                currentUser = { uid: cred.user.uid, name: name };
                showScreen('screen-menu');
            });
        }

        async function createRoom() {
            const code = Math.random().toString(36).substring(2,7).toUpperCase();
            currentRoomId = code; isHost = true;
            await db.collection('rooms').doc(code).set({
                hostId: currentUser.uid, status: 'waiting', turnIndex: 0, playerOrder: [], createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('room-code-display').innerText = code;
            joinLogic(code); showScreen('screen-create-room');
        }

        function joinRoom() {
            const code = document.getElementById('join-code-input').value.trim().toUpperCase();
            if(!code) return;
            db.collection('rooms').doc(code).get().then(doc => {
                if(!doc.exists) return alert("SALA NO EXISTE");
                currentRoomId = code; isHost = false; joinLogic(code); showScreen('screen-lobby-guest');
            });
        }

        async function joinLogic(code) {
            await db.collection('rooms').doc(code).collection('players').doc(currentUser.uid).set({
                name: currentUser.name, uid: currentUser.uid, clue: "", vote: "", role: "", joinedAt: Date.now()
            });
            listenRoom(code);
        }

        function listenRoom(code) {
            roomUnsub = db.collection('rooms').doc(code).onSnapshot(doc => {
                const data = doc.data(); if(!data) return;
                if(data.status === 'pre-start') handlePreStart(data);
                if(data.status === 'playing') setupRole(data);
                if(data.status === 'clues') handleClues(data);
                if(data.status === 'voting') setupVote();
                if(data.status === 'result') showFinalResult(data);
            });

            playersUnsub = db.collection('rooms').doc(code).collection('players').orderBy('joinedAt', 'asc').onSnapshot(snap => {
                let listHtml = "", clueHtml = "";
                snap.forEach(p => {
                    const pd = p.data(); listHtml += `<div class="player-badge">üîπ ${pd.name}</div>`;
                    clueHtml += `<div class="clue-item" id="clue-box-${pd.uid}"><div style="font-size:9px; opacity:0.6;">${pd.name}</div><div class="clue-text">${pd.clue || '...'}</div></div>`;
                });
                document.getElementById('lobby-players').innerHTML = listHtml;
                document.getElementById('lobby-players-guest').innerHTML = listHtml;
                document.getElementById('clues-grid').innerHTML = clueHtml;
            });
        }

        async function startPrep() {
            const pSnap = await db.collection('rooms').doc(currentRoomId).collection('players').get();
            if(pSnap.size < 3) return alert("M√çNIMO 3 JUGADORES");
            const prepEnd = Date.now() + 15000;
            db.collection('rooms').doc(currentRoomId).update({ status: 'pre-start', prepEnd: prepEnd });
        }

        function handlePreStart(data) {
            showScreen('screen-prep');
            const timerEl = document.getElementById('prep-timer');
            const intv = setInterval(() => {
                const diff = Math.ceil((data.prepEnd - Date.now()) / 1000);
                timerEl.innerText = diff > 0 ? diff : 0;
                if(diff <= 0) {
                    clearInterval(intv);
                    if(isHost) startGameLogic();
                }
            }, 1000);
        }

        async function startGameLogic() {
            const pSnap = await db.collection('rooms').doc(currentRoomId).collection('players').orderBy('joinedAt', 'asc').get();
            const ids = pSnap.docs.map(d => d.id);
            const impId = ids[Math.floor(Math.random() * ids.length)];
            const chosen = items[Math.floor(Math.random() * items.length)];
            const endTime = Date.now() + (3 * 60 * 1000);

            await db.collection('rooms').doc(currentRoomId).update({
                status: 'playing', impostorId: impId, word: chosen.w, quote: chosen.q,
                playerOrder: ids, turnIndex: 0, endTime: endTime
            });

            pSnap.forEach(pDoc => {
                pDoc.ref.update({ role: pDoc.id === impId ? 'impostor' : 'disciple' });
            });
        }

        async function setupRole(data) {
            const p = await db.collection('rooms').doc(currentRoomId).collection('players').doc(currentUser.uid).get();
            const isImp = p.data().role === 'impostor';
            document.getElementById('role-title').innerText = isImp ? "ERES EL FALSO PROFETA" : "ERES UN DISC√çPULO";
            document.getElementById('secret-word').innerText = isImp ? "¬°M√ÅNTENTE OCULTO!" : data.word;
            document.getElementById('secret-quote').innerText = isImp ? "No conoces el secreto. Miente para sobrevivir." : data.quote;
            showScreen('screen-reveal');
        }

        function confirmRole() {
            if(isHost) db.collection('rooms').doc(currentRoomId).update({ status: 'clues' });
            else showScreen('screen-clues');
        }

        function handleClues(data) {
            showScreen('screen-clues');
            startDebateTimer(data.endTime);
            const turnUid = data.playerOrder[data.turnIndex];
            document.querySelectorAll('.clue-item').forEach(el => el.classList.remove('active-turn'));
            const activeBox = document.getElementById(`clue-box-${turnUid}`);
            if(activeBox) activeBox.classList.add('active-turn');

            db.collection('rooms').doc(currentRoomId).collection('players').doc(turnUid).get().then(d => {
                document.getElementById('clue-turn-msg').innerText = `TURNO DE: ${d.data().name.toUpperCase()}`;
            });
            document.getElementById('my-clue-input-area').style.display = (turnUid === currentUser.uid) ? 'block' : 'none';
        }

        async function submitClue() {
            const val = document.getElementById('clue-input').value.trim();
            if(!val || val.split(/\s+/).length > 2) return alert("M√ÅXIMO 2 PALABRAS");
            await db.collection('rooms').doc(currentRoomId).collection('players').doc(currentUser.uid).update({ clue: val });
            const r = await db.collection('rooms').doc(currentRoomId).get();
            const nextIdx = r.data().turnIndex + 1;
            if(nextIdx < r.data().playerOrder.length) {
                db.collection('rooms').doc(currentRoomId).update({ turnIndex: nextIdx });
            }
        }

        function startDebateTimer(endTime) {
            const timerEl = document.getElementById('timer');
            const intv = setInterval(() => {
                const diff = endTime - Date.now();
                if(diff <= 0) {
                    clearInterval(intv);
                    if(isHost) db.collection('rooms').doc(currentRoomId).update({ status: 'voting' });
                }
                const m = Math.floor(diff / 60000), s = Math.floor((diff % 60000) / 1000);
                timerEl.innerText = `${m}:${s < 10 ? '0'+s : s}`;
            }, 1000);
        }

        async function setupVote() {
            const pSnap = await db.collection('rooms').doc(currentRoomId).collection('players').get();
            let html = "";
            pSnap.forEach(p => {
                if(p.id !== currentUser.uid) html += `<button class="btn btn-gold" id="btn-v-${p.id}" onclick="castVote('${p.id}')">${p.data().name}</button>`;
            });
            document.getElementById('vote-grid').innerHTML = html;
            showScreen('screen-vote');
        }

        async function castVote(targetId) {
            document.getElementById('vote-grid').style.pointerEvents = 'none';
            document.getElementById('vote-wait-msg').style.display = 'block';
            await db.collection('rooms').doc(currentRoomId).collection('players').doc(currentUser.uid).update({ vote: targetId });
            
            // Comprobar si todos han votado
            const players = await db.collection('rooms').doc(currentRoomId).collection('players').get();
            const allVoted = players.docs.every(d => d.data().vote !== "");
            
            if(allVoted && isHost) {
                const rData = (await db.collection('rooms').doc(currentRoomId).get()).data();
                let votes = {}, summary = "";
                players.forEach(p => {
                    const d = p.data(), vName = players.docs.find(x => x.id === d.vote)?.data().name || "Nadie";
                    summary += `<div><b>${d.name}</b> vot√≥ a -> ${vName}</div>`;
                    votes[d.vote] = (votes[d.vote] || 0) + 1;
                });
                let mostVotedId = Object.keys(votes).reduce((a, b) => votes[a] > votes[b] ? a : b);
                db.collection('rooms').doc(currentRoomId).update({
                    status: 'result', winner: mostVotedId === rData.impostorId ? 'DISCIPLES' : 'IMPOSTOR',
                    summary: summary, impostorName: players.docs.find(x => x.id === rData.impostorId).data().name
                });
            }
        }

        function showFinalResult(data) {
            document.getElementById('res-status').innerText = data.winner === 'DISCIPLES' ? "¬°LOGRARON EXPULSARLO!" : "¬°EL PROFETA LOS ENGA√ë√ì!";
            document.getElementById('res-impostor').innerText = data.impostorName;
            document.getElementById('vote-summary').innerHTML = data.summary;
            showScreen('screen-result');
        }

        async function exitRoom() { if(currentRoomId) { await db.collection('rooms').doc(currentRoomId).collection('players').doc(currentUser.uid).delete(); location.reload(); } }
    </script>
</body>
</html>
