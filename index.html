<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Falso Profeta Online</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --gold: #e2b04a;
            --gold-dark: #b8860b;
            --bg: #050505;
            --card: rgba(15, 15, 15, 0.98);
            --accent: #ff3e3e;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg);
            color: white;
            height: 100vh;
            overflow: hidden;
            background: radial-gradient(circle at center, #1a150a 0%, #050505 100%);
        }

        /* ANIMACI√ìN DE SIGNOS DE INTERROGACI√ìN */
        .bg-animation {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        .q-mark {
            position: absolute;
            color: var(--gold);
            opacity: 0.1;
            font-weight: 900;
            font-size: 3rem;
            animation: float 8s linear infinite;
        }
        @keyframes float {
            0% { transform: translateY(110vh) rotate(0deg); opacity: 0; }
            20% { opacity: 0.1; }
            80% { opacity: 0.1; }
            100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
        }

        /* CONTROL DE M√öSICA */
        .music-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 10px;
            border-radius: 50%;
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }

        .social-container {
            position: fixed;
            bottom: 45px;
            left: 0; width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 100;
        }
        .social-link {
            width: 35px; height: 35px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--gold-dark);
            text-decoration: none;
        }

        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%; width: 100%;
            padding: 15px;
            text-align: center;
            position: absolute;
            z-index: 10;
        }
        .active { display: flex; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .glass-card {
            background: var(--card);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 25px;
            padding: 20px;
            width: 100%; max-width: 380px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.8);
            max-height: 85vh;
            overflow-y: auto;
        }

        .login-img {
            width: 130px;
            height: 130px;
            object-fit: contain;
            margin-bottom: 20px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            background: rgba(0,0,0,0.5);
        }

        .btn {
            background: linear-gradient(135deg, #222 0%, #000 100%);
            border: 1px solid var(--gold-dark);
            color: white;
            padding: 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            width: 100%;
            margin: 5px 0;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-gold { background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); color: black; border: none; }
        .btn-exit { border-color: var(--accent); color: var(--accent); }

        input[type="text"] {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px; border-radius: 12px;
            color: white; width: 100%; margin-bottom: 10px;
            text-align: center; font-size: 16px;
        }

        .chat-box {
            width: 100%; height: 30vh;
            overflow-y: auto;
            margin: 10px 0;
            display: flex; flex-direction: column; gap: 5px;
            padding: 10px; background: rgba(0,0,0,0.3);
            border-radius: 15px;
        }
        .message {
            font-size: 11px; padding: 6px 10px;
            border-radius: 8px; text-align: left;
            background: rgba(255,255,255,0.05);
            border-left: 3px solid var(--gold);
        }
        .message.my-message { border-left-color: #fff; background: rgba(255,255,255,0.1); }
        .message b { color: var(--gold); font-size: 9px; display: block; }

        #timer { font-size: 40px; font-weight: 900; color: var(--gold); }
        
        #vote-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            max-height: 40vh;
            overflow-y: auto;
            padding: 5px;
        }

        footer { position: fixed; bottom: 10px; width: 100%; text-align: center; font-size: 8px; opacity: 0.4; }
    </style>
</head>
<body>

    <!-- ELEMENTO DE AUDIO -->
    <audio id="bg-music" loop>
        <source src="suspense-dramatic-248023.mp3" type="audio/mpeg">
    </audio>

    <div class="music-control" onclick="toggleMusic()">
        <i id="music-icon" class="fas fa-volume-mute"></i>
    </div>

    <div class="bg-animation" id="bg-animation"></div>

    <div class="social-container">
        <a href="https://www.youtube.com/channel/UCjKTs1EPUXqaZ9_tBjwFQhQ" class="social-link" target="_blank"><i class="fab fa-youtube"></i></a>
        <a href="https://www.instagram.com/robert_paraco?igsh=MWx1NXdpZDIxdHdsMg==" class="social-link" target="_blank"><i class="fab fa-instagram"></i></a>
        <a href="https://www.tiktok.com/@robert_paraco?_r=1&_t=ZM-92YDqsdjjAZ" class="social-link" target="_blank"><i class="fab fa-tiktok"></i></a>
    </div>

    <!-- 1. LOGIN -->
    <div id="screen-login" class="screen active">
        <div class="glass-card">
            <img src="img1.png" class="login-img" alt="Logo">
            <h2 style="color:var(--gold); margin-bottom: 15px;">FALSO PROFETA</h2>
            <input type="text" id="login-name" placeholder="Tu nombre...">
            <button class="btn btn-gold" onclick="login()">ENTRAR AL TEMPLO</button>
        </div>
    </div>

    <!-- 2. MENU -->
    <div id="screen-menu" class="screen">
        <div class="glass-card">
            <button class="btn btn-gold" onclick="createRoom()">CREAR SALA ONLINE</button>
            <button class="btn" onclick="showScreen('screen-join-room')">UNIRSE A SALA</button>
            <button class="btn btn-exit" onclick="location.reload()">SALIR</button>
        </div>
    </div>

    <!-- 3. LOBBY HOST -->
    <div id="screen-create-room" class="screen">
        <div class="glass-card">
            <h2 style="color:var(--gold)">C√ìDIGO: <span id="room-code-display">---</span></h2>
            <div id="lobby-players" style="margin: 15px 0; text-align: left; font-size: 12px;"></div>
            <button class="btn btn-gold" onclick="startPrep()">INICIAR PARTIDA</button>
            <button class="btn btn-exit" onclick="location.reload()">CANCELAR</button>
        </div>
    </div>

    <!-- 4. UNIRSE -->
    <div id="screen-join-room" class="screen">
        <div class="glass-card">
            <input type="text" id="join-code-input" placeholder="C√ìDIGO DE SALA" style="text-transform: uppercase;">
            <button class="btn btn-gold" onclick="joinRoom()">UNIRSE</button>
            <button class="btn" onclick="showScreen('screen-menu')">VOLVER</button>
        </div>
    </div>

    <!-- 5. LOBBY GUEST -->
    <div id="screen-lobby-guest" class="screen">
        <div class="glass-card">
            <h2 style="color:var(--gold)">ESPERANDO AL GU√çA...</h2>
            <div id="lobby-players-guest" style="margin: 15px 0; text-align: left; font-size: 12px;"></div>
        </div>
    </div>

    <!-- 6. PREPARACI√ìN -->
    <div id="screen-prep" class="screen">
        <div class="glass-card">
            <h2 style="color:var(--gold)">ANALIZANDO ALMAS...</h2>
            <div id="prep-timer" style="font-size: 50px; font-weight: 900;">15</div>
        </div>
    </div>

    <!-- 7. ROL -->
    <div id="screen-reveal" class="screen">
        <div class="glass-card">
            <h2 id="role-title">TU ROL</h2>
            <div id="secret-word" style="font-size: 24px; color: var(--gold); margin: 15px 0; font-weight: 900;">---</div>
            <p id="secret-quote" style="font-style: italic; font-size: 12px; opacity: 0.8;"></p>
            <button class="btn btn-gold" style="margin-top: 15px;" onclick="confirmRole()">IR AL DEBATE</button>
        </div>
    </div>

    <!-- 8. CHAT DE PISTAS -->
    <div id="screen-clues" class="screen">
        <div id="timer">02:00</div>
        <div id="turn-indicator" style="font-size: 11px; color: var(--gold); margin-bottom: 5px;">CARGANDO...</div>
        <div id="chat-area" class="chat-box"></div>
        <div id="clue-input-area" style="display:none; width: 100%; max-width: 340px;">
            <input type="text" id="clue-input" placeholder="2 PALABRAS M√ÅXIMO">
            <button class="btn btn-gold" onclick="sendClue()">ENVIAR PISTA</button>
        </div>
        <p id="wait-turn-msg" style="font-size: 10px; opacity: 0.5;">Observa las se√±ales de los dem√°s...</p>
    </div>

    <!-- 9. VOTACI√ìN -->
    <div id="screen-vote" class="screen">
        <div class="glass-card">
            <h3 style="color: var(--accent); margin-bottom: 10px;">¬øQUI√âN ES EL IMPOSTOR?</h3>
            <div id="vote-grid"></div>
            <p id="vote-wait-msg" style="margin-top: 10px; font-size: 10px; color: var(--gold); display:none;">Esperando el veredicto de los dem√°s...</p>
        </div>
    </div>

    <!-- 10. RESULTADO -->
    <div id="screen-result" class="screen">
        <div class="glass-card">
            <h2 id="res-status">-</h2>
            <p style="font-size: 10px; opacity: 0.6; margin-top: 10px;">EL FALSO PROFETA ERA:</p>
            <h1 id="res-impostor" style="color: var(--gold); font-size: 24px;">---</h1>
            <div id="vote-summary" style="font-size: 10px; margin: 15px 0; text-align: left; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 10px;"></div>
            <button class="btn btn-gold" onclick="location.reload()">VOLVER AL TEMPLO</button>
        </div>
    </div>

    <footer>DISE√ëADO POR - ROBERT PARACO</footer>

    <script>
        const firebaseConfig = {
             apiKey: "AIzaSyCc0dMjTppOlnGV_NuXCFUGhx7882qbZlE",
             authDomain: "falsoprofeta-6e682.firebaseapp.com",
             projectId: "falsoprofeta-6e682",
             storageBucket: "falsoprofeta-6e682.firebasestorage.app",
             messagingSenderId: "480777785862",
             appId: "1:480777785862:web:8c5886c6e9a2d132356987"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // LISTA EXTENDIDA DE PERSONAJES Y LUGARES
        const biblicalItems = [
            // PERSONAJES
            {w: "Ad√°n", q: "Formado del polvo de la tierra (G√©nesis 2:7)"}, {w: "Eva", q: "Madre de todos los vivientes (G√©nesis 3:20)"},
            {w: "Ca√≠n", q: "¬øSoy yo guarda de mi hermano? (G√©nesis 4:9)"}, {w: "Abel", q: "Ofreci√≥ un sacrificio m√°s excelente (Hebreos 11:4)"},
            {w: "Matusal√©n", q: "Vivi√≥ 969 a√±os (G√©nesis 5:27)"}, {w: "No√©", q: "Hizo un arca de madera (G√©nesis 6:14)"},
            {w: "Abraham", q: "Padre de muchas naciones (G√©nesis 17:5)"}, {w: "Isaac", q: "El hijo de la promesa (G√©nesis 21:3)"},
            {w: "Jacob", q: "Luch√≥ con un √°ngel (G√©nesis 32:24)"}, {w: "Jos√©", q: "El so√±ador de t√∫nica de colores (G√©nesis 37:3)"},
            {w: "Mois√©s", q: "Subi√≥ al monte Sina√≠ (√âxodo 19:20)"}, {w: "Aar√≥n", q: "El primer sumo sacerdote (Lev√≠tico 8:12)"},
            {w: "Josu√©", q: "Hizo que el sol se detuviera (Josu√© 10:12)"}, {w: "Sans√≥n", q: "Su fuerza estaba en su cabello (Jueces 16:17)"},
            {w: "Gede√≥n", q: "Venci√≥ con solo 300 hombres (Jueces 7:7)"}, {w: "David", q: "El rey conforme al coraz√≥n de Dios (1 Samuel 13:14)"},
            {w: "Salom√≥n", q: "El hombre m√°s sabio (1 Reyes 3:12)"}, {w: "El√≠as", q: "Subi√≥ al cielo en un torbellino (2 Reyes 2:11)"},
            {w: "Eliseo", q: "Pidi√≥ una doble porci√≥n de esp√≠ritu (2 Reyes 2:9)"}, {w: "Job", q: "Jehov√° dio, Jehov√° quit√≥ (Job 1:21)"},
            {w: "Daniel", q: "Sobrevivi√≥ al foso de leones (Daniel 6:22)"}, {w: "Ester", q: "Reina que salv√≥ a su pueblo (Ester 7)"},
            {w: "Jon√°s", q: "Estuvo en el vientre del gran pez (Jon√°s 1:17)"}, {w: "Juan el Bautista", q: "Bautizaba en el Jord√°n (Mateo 3:6)"},
            {w: "Pedro", q: "Camin√≥ sobre las aguas (Mateo 14:29)"}, {w: "Pablo", q: "Ap√≥stol de los gentiles (Romanos 11:13)"},
            {w: "L√°zaro", q: "¬°Sal fuera! (Juan 11:43)"}, {w: "Zaqueo", q: "Subi√≥ a un √°rbol sic√≥moro (Lucas 19:4)"},
            {w: "Herodes", q: "Buscaba al ni√±o para matarlo (Mateo 2:13)"}, {w: "Nabucodonosor", q: "Rey de Babilonia (Daniel 4:1)"},
            {w: "Mar√≠a Magdalena", q: "Siete demonios salieron de ella (Lucas 8:2)"}, {w: "Esteban", q: "El primer m√°rtir (Hechos 7:59)"},
            
            // LUGARES
            {w: "Ed√©n", q: "El huerto de la delicia (G√©nesis 2:8)"}, {w: "Babel", q: "Donde se confundieron las lenguas (G√©nesis 11:9)"},
            {w: "Sodoma", q: "Ciudad destruida por fuego (G√©nesis 19:24)"}, {w: "Egipto", q: "De donde salieron con mano fuerte (√âxodo 13:3)"},
            {w: "Jeric√≥", q: "Sus muros cayeron con gritos (Josu√© 6:20)"}, {w: "Bel√©n", q: "Donde naci√≥ el Rey de reyes (Mateo 2:1)"},
            {w: "Nazaret", q: "¬øDe Nazaret puede salir algo bueno? (Juan 1:46)"}, {w: "Jerusal√©n", q: "La ciudad santa (Apocalipsis 21:2)"},
            {w: "Getseman√≠", q: "Donde Jes√∫s or√≥ con sudor de sangre (Lucas 22:44)"}, {w: "G√≥lgota", q: "El lugar de la calavera (Juan 19:17)"},
            {w: "N√≠nive", q: "Ciudad a la que Jon√°s no quer√≠a ir (Jon√°s 1:2)"}, {w: "Monte Carmelo", q: "Donde El√≠as ret√≥ a los profetas de Baal (1 Reyes 18)"},
            {w: "Mar Rojo", q: "Se abri√≥ para que pasara el pueblo (√âxodo 14)"}, {w: "R√≠o Jord√°n", q: "Donde fue bautizado el Se√±or (Mateo 3)"},
            
            // OBJETOS Y EVENTOS
            {w: "El Arca del Pacto", q: "Conten√≠a las tablas de la ley (Hebreos 9:4)"}, {w: "Man√°", q: "Pan ca√≠do del cielo (√âxodo 16:31)"},
            {w: "Pentecost√©s", q: "Lenguas como de fuego (Hechos 2:3)"}, {w: "El Diluvio", q: "Llovi√≥ 40 d√≠as y 40 noches (G√©nesis 7:12)"},
            {w: "La Zarza Ardiendo", q: "Ard√≠a y no se consum√≠a (√âxodo 3:2)"}
        ];

        let currentUser = null, currentRoomId = null, isHost = false, timerInterval = null;

        // FUNCI√ìN DE M√öSICA
        function toggleMusic() {
            const music = document.getElementById('bg-music');
            const icon = document.getElementById('music-icon');
            if (music.paused) {
                music.play();
                icon.className = 'fas fa-volume-up';
            } else {
                music.pause();
                icon.className = 'fas fa-volume-mute';
            }
        }

        function initBg() {
            const container = document.getElementById('bg-animation');
            for(let i=0; i<15; i++) {
                const mark = document.createElement('div');
                mark.className = 'q-mark'; mark.innerText = '?';
                mark.style.left = Math.random() * 100 + 'vw';
                mark.style.animationDelay = Math.random() * 8 + 's';
                mark.style.fontSize = (Math.random() * 3 + 1) + 'rem';
                container.appendChild(mark);
            }
        }
        initBg();

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function login() {
            const name = document.getElementById('login-name').value.trim();
            if(!name) return;
            
            // Activar m√∫sica al entrar
            const music = document.getElementById('bg-music');
            music.play().catch(e => console.log("Audio bloqueado, esperando interacci√≥n"));
            document.getElementById('music-icon').className = 'fas fa-volume-up';

            auth.signInAnonymously().then(cred => {
                currentUser = { uid: cred.user.uid, name: name };
                showScreen('screen-menu');
            });
        }

        async function createRoom() {
            const code = Math.random().toString(36).substring(2,7).toUpperCase();
            currentRoomId = code; isHost = true;
            await db.collection('rooms').doc(code).set({
                hostId: currentUser.uid, status: 'waiting', turnIndex: 0, playerOrder: [], lastImpostorId: "", createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('room-code-display').innerText = code;
            joinLogic(code); showScreen('screen-create-room');
        }

        function joinRoom() {
            const code = document.getElementById('join-code-input').value.trim().toUpperCase();
            if(!code) return;
            db.collection('rooms').doc(code).get().then(doc => {
                if(!doc.exists) return alert("SALA NO EXISTE");
                currentRoomId = code; isHost = false; joinLogic(code); showScreen('screen-lobby-guest');
            });
        }

        async function joinLogic(code) {
            await db.collection('rooms').doc(code).collection('players').doc(currentUser.uid).set({
                name: currentUser.name, uid: currentUser.uid, vote: "", joinedAt: Date.now()
            });
            listenRoom(code);
        }

        function listenRoom(code) {
            db.collection('rooms').doc(code).onSnapshot(doc => {
                const data = doc.data(); if(!data) return;
                if(data.status === 'pre-start') handlePreStart(data);
                if(data.status === 'playing') setupRole(data);
                if(data.status === 'clues') handleClues(data);
                if(data.status === 'voting') setupVote();
                if(data.status === 'result') showFinalResult(data);
            });

            db.collection('rooms').doc(code).collection('players').orderBy('joinedAt', 'asc').onSnapshot(snap => {
                let listHtml = "";
                snap.forEach(p => { listHtml += `<div>üîπ ${p.data().name}</div>`; });
                document.getElementById('lobby-players').innerHTML = listHtml;
                document.getElementById('lobby-players-guest').innerHTML = listHtml;
            });

            db.collection('rooms').doc(code).collection('chat').orderBy('time', 'asc').onSnapshot(snap => {
                const box = document.getElementById('chat-area');
                box.innerHTML = "";
                snap.forEach(m => {
                    const md = m.data();
                    const div = document.createElement('div');
                    div.className = `message ${md.uid === currentUser.uid ? 'my-message' : ''}`;
                    div.innerHTML = `<b>${md.name}</b> ${md.text}`;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        async function startPrep() {
            const pSnap = await db.collection('rooms').doc(currentRoomId).collection('players').get();
            if(pSnap.size < 3) return alert("M√çNIMO 3 JUGADORES");
            db.collection('rooms').doc(currentRoomId).update({ status: 'pre-start', prepEnd: Date.now() + 15000 });
        }

        function handlePreStart(data) {
            showScreen('screen-prep');
            const timerEl = document.getElementById('prep-timer');
            const intv = setInterval(() => {
                const diff = Math.ceil((data.prepEnd - Date.now()) / 1000);
                timerEl.innerText = diff > 0 ? diff : 0;
                if(diff <= 0) {
                    clearInterval(intv);
                    if(isHost) startGameLogic();
                }
            }, 1000);
        }

        async function startGameLogic() {
            const roomRef = db.collection('rooms').doc(currentRoomId);
            const rSnap = await roomRef.get();
            const rData = rSnap.data();
            
            const pSnap = await roomRef.collection('players').get();
            const ids = pSnap.docs.map(d => d.id);
            
            let candidates = ids.filter(id => id !== rData.lastImpostorId);
            if(candidates.length === 0) candidates = ids;

            const impId = candidates[Math.floor(Math.random() * candidates.length)];
            const chosen = biblicalItems[Math.floor(Math.random() * biblicalItems.length)];
            const endTime = Date.now() + (2 * 60 * 1000);
            const randomOrder = [...ids].sort(() => Math.random() - 0.5);

            const batch = db.batch();
            pSnap.docs.forEach(d => batch.update(d.ref, { vote: "" }));
            await batch.commit();

            await roomRef.update({
                status: 'playing', 
                impostorId: impId, 
                lastImpostorId: impId,
                word: chosen.w, 
                quote: chosen.q,
                playerOrder: randomOrder, 
                turnIndex: 0, 
                endTime: endTime
            });
        }

        async function setupRole(data) {
            const isImp = (data.impostorId === currentUser.uid);
            document.getElementById('role-title').innerText = isImp ? "FALSO PROFETA" : "DISC√çPULO";
            document.getElementById('secret-word').innerText = isImp ? "¬°ESC√ìNDETE!" : data.word;
            document.getElementById('secret-quote').innerText = isImp ? "No sabes el secreto. ¬°Miente bien!" : data.quote;
            showScreen('screen-reveal');
        }

        function confirmRole() {
            if(isHost) db.collection('rooms').doc(currentRoomId).update({ status: 'clues' });
            else showScreen('screen-clues');
        }

        function handleClues(data) {
            showScreen('screen-clues');
            if(!timerInterval) startDebateTimer(data.endTime);
            const turnUid = data.playerOrder[data.turnIndex];
            const isMyTurn = (turnUid === currentUser.uid);
            db.collection('rooms').doc(currentRoomId).collection('players').doc(turnUid).get().then(d => {
                if(d.exists) document.getElementById('turn-indicator').innerText = `TURNO DE: ${d.data().name.toUpperCase()}`;
            });
            document.getElementById('clue-input-area').style.display = isMyTurn ? 'block' : 'none';
            document.getElementById('wait-turn-msg').style.display = isMyTurn ? 'none' : 'block';
        }

        async function sendClue() {
            const input = document.getElementById('clue-input');
            const val = input.value.trim();
            if(!val || val.split(/\s+/).length > 2) return alert("M√ÅXIMO 2 PALABRAS");
            await db.collection('rooms').doc(currentRoomId).collection('chat').add({
                name: currentUser.name, uid: currentUser.uid, text: val.toUpperCase(), time: Date.now()
            });
            input.value = "";
            const rData = (await db.collection('rooms').doc(currentRoomId).get()).data();
            let nextIdx = (rData.turnIndex + 1) % rData.playerOrder.length; 
            db.collection('rooms').doc(currentRoomId).update({ turnIndex: nextIdx });
        }

        function startDebateTimer(endTime) {
            const timerEl = document.getElementById('timer');
            timerInterval = setInterval(() => {
                const diff = endTime - Date.now();
                if(diff <= 0) {
                    clearInterval(timerInterval); timerInterval = null;
                    if(isHost) db.collection('rooms').doc(currentRoomId).update({ status: 'voting' });
                    return;
                }
                const m = Math.floor(diff / 60000), s = Math.floor((diff % 60000) / 1000);
                timerEl.innerText = `${m}:${s < 10 ? '0'+s : s}`;
            }, 1000);
        }

        async function setupVote() {
            const pSnap = await db.collection('rooms').doc(currentRoomId).collection('players').get();
            let html = "";
            pSnap.forEach(p => { 
                if(p.id !== currentUser.uid) 
                    html += `<button class="btn btn-gold" onclick="castVote('${p.id}')">${p.data().name}</button>`; 
            });
            document.getElementById('vote-grid').innerHTML = html;
            document.getElementById('vote-grid').style.pointerEvents = 'auto';
            document.getElementById('vote-wait-msg').style.display = 'none';
            showScreen('screen-vote');
        }

        async function castVote(targetId) {
            document.getElementById('vote-grid').style.pointerEvents = 'none';
            document.getElementById('vote-wait-msg').style.display = 'block';
            await db.collection('rooms').doc(currentRoomId).collection('players').doc(currentUser.uid).update({ vote: targetId });
            if(isHost) checkAllVotes();
        }

        async function checkAllVotes() {
            const players = await db.collection('rooms').doc(currentRoomId).collection('players').get();
            const allVoted = players.docs.every(d => d.data().vote && d.data().vote !== "");
            if(allVoted) {
                const rSnap = await db.collection('rooms').doc(currentRoomId).get();
                const rData = rSnap.data();
                let votes = {}, summary = "";
                players.forEach(p => {
                    const d = p.data(); 
                    const targetName = players.docs.find(x => x.id === d.vote)?.data().name || "---";
                    summary += `<div><b>${d.name}</b> vot√≥ a: ${targetName}</div>`;
                    votes[d.vote] = (votes[d.vote] || 0) + 1;
                });
                let mostVotedId = Object.keys(votes).reduce((a, b) => votes[a] > votes[b] ? a : b);
                const impostorDoc = players.docs.find(x => x.id === rData.impostorId);
                db.collection('rooms').doc(currentRoomId).update({
                    status: 'result', 
                    winner: mostVotedId === rData.impostorId ? 'DISCIPLES' : 'IMPOSTOR',
                    summary: summary, 
                    impostorName: impostorDoc ? impostorDoc.data().name : "Desconocido"
                });
            } else { setTimeout(checkAllVotes, 2000); }
        }

        function showFinalResult(data) {
            const statusEl = document.getElementById('res-status');
            statusEl.innerText = data.winner === 'DISCIPLES' ? "¬°LOGRARON EXPULSARLO!" : "¬°EL PROFETA LOS ENGA√ë√ì!";
            statusEl.style.color = data.winner === 'DISCIPLES' ? "var(--gold)" : "var(--accent)";
            document.getElementById('res-impostor').innerText = data.impostorName;
            document.getElementById('vote-summary').innerHTML = data.summary;
            showScreen('screen-result');
        }
    </script>
</body>
</html>
